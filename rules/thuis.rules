import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*
import java.lang.Math.*

//1.27 = 100%, but leds are ~even bright at ~80%
var float rscalar = (1.27 * 1.0).floatValue()
var float gscalar = (1.27 * 1.0).floatValue()
var float bscalar = (1.27 * 1.0).floatValue()



rule "dimmer_bed Bedlight RGB"
	when
		Item dimmer_bed received command
	then
	    var Number percent = 0
	
		if(dimmer_bed.state instanceof DecimalType) percent = dimmer_bed.state as DecimalType 
			
		if(receivedCommand==INCREASE) percent = percent + 5
		if(receivedCommand==DECREASE) percent = percent - 5
		if(receivedCommand==OFF) percent = 0
		
		if(percent<0)   percent = 0
		if(percent>100) percent = 100
		
		
		//we scale decimally, not hexadicimal!
		val Number scale = Math::floor( percent.floatValue * 1.27).intValue
		val cmd = String::format("LEDD1r%c\n", scale )
		logInfo("bedlight" , "bedLight send " + cmd)
		sendCommand(Msp, cmd)
		postUpdate(dimmer_bed, percent);
end

rule "RGB Links"
	when Item  RGB_links received command
	then
	var HSBType hsbType
	if (RGB_links.state instanceof HSBType) hsbType = RGB_links.state as HSBType
	
	var r = Math::floor( hsbType.red.floatValue * rscalar).intValue()
	var g = Math::floor( hsbType.green.floatValue * gscalar).intValue()
	var b = Math::floor( hsbType.blue.floatValue * bscalar).intValue()
	
	println(String::format("Color settings: %d %d %d", hsbType.red.intValue(), hsbType.green.intValue(), 
			hsbType.blue.intValue()
	))
	var cmd = String::format("LEDR1%s%s%sXX\n", r,g,b)
	logInfo("RGB links", "cmd: " + cmd)
	
	sendCommand(Msp, cmd)
end
